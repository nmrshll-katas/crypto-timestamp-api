# crypto-timestamp-api

A cryptographic timestamping HTTP server.

It allows users to post data and get cryptographic signatures from the service's private key. The service has a known public key.
Any user can query the service's public key and verify the signature.
The service makes it impossible to get more than one signature on the same data.

## API docs

### Open Endpoints

- [Get server's public key](#) : `GET /pubkey`

   <details>
   <summary>Params and responses</summary>
   <p>
   
   #### Success Response: `200 OK`

  ```
  {"pubkey":[222,236,199,22,195,251,219,75,107,23,234,109,199,216,127,219,93,230,141,33,108,30,16,119,149,242,81,129,244,104,153,164]}
  ```

   </p>
   </details>

- [Timstamp and sign data](#) : `POST /sign_data`

    <details>
    <summary>Params and responses</summary>
    <p>

  #### Request format

  ```json
  {
    "data_base64": "[valid base64 string]",
    "pow_proof_base64": "[solution to cuckoo challenge, in valid base64 string]"
  }
  ```

  **Example**

  ```json
  {
    "data_base64": "MiqKe3ZAXYwdvWXnq3fSje7McWw",
    "pow_proof_base64": "McWw/vbS2sX6m3H2H/bXeaNIWweEHeV8lGB9GiZpA=="
  }
  ```

  #### Success Response: `200 OK`

  ```json
  {
    "fields_signed": {
      "data_hash_base64": "dg8nKCrQ60imxV5PR+5OeBMB1SWxgK5c1fmN0kRYNos=",
      "timestamp": "2020-10-12T18:45:18.139163"
    },
    "signature_base64": "qZ5XXOFnQfFvfXebCGWtVD4FlQxuMNY6TgztcPLC6VjE86/WqZKR7QbOPZTdFvk6T9UBUOJK9cLvL4c+o4bfCw=="
  }
  ```

    </p>
    </details>

## Usage

#### Launching in dev mode (recommended)

API and migrations on your local machine, postgres in Docker (+ adminer in Docker for convenience):

Run it with:

```
make
```

#### Alternative usage options

<table>
<thead>
<tr>
<th>Full setup, in docker</th>
<th>API only, in docker</th>
<th>Local testing</th>
</tr>
</thead>
<tbody>
<tr>
<td>   
   <details>
   <summary>Instructions</summary>
   <p>API, migrations, postgres and adminer each in a Docker container. This mode is intended for deployment.

Run it with:

```shell
make dockerized
```

   </p>
   </details>
</td>
<td>
   <details>
   <summary>Instructions</summary>
   <p>Only the API server will run in docker, you must provide a postgres database and configure the API to discover it.

Run it with:

```shell
docker run --rm -d docker.pkg.github.com/nmrshll-katas/crypto-timestamp-api/api:latest
```

   </p>
   </details>
</td>
<td>   
   <details>
   <summary>Instructions</summary>
   <p>Run tests. Cargo tests and migrations on your machine, postgres in docker.

Run it with:

```shell
make test
```

   </p>
   </details>
</td>
</tr>
</tbody>
</table>

## Configuration options

Configuration is applied, from highest to lowest priority, through:

- Environment variables
- Signing key file at `./.cache/keys/keypair_sign`.
  For docker, provide via volume.
- Config file located at `./.config/api_config(.ext)?` (relative to the binary).
  Format and extension `(.ext)?` can be `json`,`yaml`,`toml`,`hcl`, `ini` or none (autodetected).
  For docker, provide via volume.

- Hardcoded defaults

These options are:

| Option            | ENV_VAR             | Config file    | Config key          | Value format | Default              |
| ----------------- | :------------------ | :------------- | :------------------ | :----------- | -------------------- |
| Postgres DSN      | `DATABASE_URL`      | `api_config`   | `database_url`      |              | (autogenerated)      |
| Postgres user     | `POSTGRES_USER`     | `api_config`   | `postgres_user`     |              |                      |
| Postgres password | `POSTGRES_PASSWORD` | `api_config`   | `postgres_password` |              |                      |
| Postgres database | `POSTGRES_DB`       | `api_config`   | `postgres_db`       |              |                      |
| Postgres host     | `POSTGRES_HOST`     | `api_config`   | `postgres_db`       |              |                      |
| HTTP port         | `HTTP_PORT`         | `api_config`   | `http_port`         |              | `8080`               |
| Log level         | `RUST_LOG`          | `api_config`   | `postgres_db`       |              | `auth-rs-warp=debug` |
| Enable backtraces | `RUST_BACKTRACE`    | `api_config`   | `rust_backtrace`    |              | `1`                  |
| Signing key       | (not available)     | `keypair_sign` | `rust_backtrace`    | base64       | (autogenerated)      |

Note: At least one of `database_url` / `postgres_host/user/pw/db` must be defined. If both defined they must be compatible
